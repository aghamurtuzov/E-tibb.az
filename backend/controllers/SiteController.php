<?phpnamespace backend\controllers;use Yii;use yii\web\Controller;use yii\filters\VerbFilter;use yii\filters\AccessControl;use backend\models\LoginForm;use backend\models\AdminUsers;/** * Site controller */class SiteController extends Controller{    /**     * {@inheritdoc}     */    public function behaviors()    {        return [            'access' => [                'class' => AccessControl::className(),                'rules' => [                    [                        'actions' => ['login','doctor','enterprise'],                        'allow' => true,                    ],                    [                        'actions' => ['index','logout','general','error'],                        'allow' => true,                        'roles' => ['@'],                    ],                ],            ],            /*            'verbs' => [                'class' => VerbFilter::className(),                'actions' => [                    'logout' => ['post'],                ],            ],            */        ];    }    /**     * {@inheritdoc}     */    public function actions()    {        return [            'error' => [                'class' => 'yii\web\ErrorAction',            ],        ];    }    /**     * Displays homepage.     *     * @return string     */    public function actionIndex()    {        return $this->redirect(['general']);//        return $this->render('index');    }    /**     * Login action.     *     * @return string     */    public function actionLogin()    {        //Yii::$app->db->schema->refresh();        //Yii::$app->user->logout();        /*        $login = Yii::$app->params['firstLogin'];        $pass  = Yii::$app->params['firstPass'];        if ((md5(strrev(md5(@$_SERVER['PHP_AUTH_PW']))) != $pass || @$_SERVER['PHP_AUTH_USER'] != $login) || !@$_SERVER['PHP_AUTH_USER']) {            header('WWW-Authenticate: Basic realm="Access denied"');            header('HTTP/1.0 401 Unauthorized');            echo 'Auth failed';            exit;        }        */        if(!Yii::$app->user->isGuest){            return $this->goHome();        }        $key = Yii::$app->session->get('gakey');        if(empty($key))        {            Yii::$app->user->logout();        }        $model = new LoginForm();        if($model->load(Yii::$app->request->post()) && $model->login())        {            $session = Yii::$app->session;            $session->remove('userID');            $session->remove('userType');            Yii::$app->db->schema->refresh();            $rand = rand(100000,900000);            Yii::$app->session->set('gakey',$rand);            $user = AdminUsers::find()->where(['username'=>$model->username])->one();            $user->login_key = empty($user->login_key) ? $rand : $user->login_key.','.$rand;            $user->save(false);            return $this->redirect(['general']);        }else{            $model->password = '';            return $this->renderPartial('login', [                'model' => $model,            ]);        }    }    public function actionGeneral()    {        $key = Yii::$app->session->get('gakey');        if(empty($key))        {            Yii::$app->user->logout();            return $this->redirect('https://e-tibb.az/admin');        }        return $this->renderPartial('/vue/index');    }    public function actionDoctor()    {        $userID = Yii::$app->session->get('userID');        $userTYPE = Yii::$app->session->get('userType');        $userTYPE = intval($userTYPE);        if(empty($userID) || ($userTYPE<=0 || $userTYPE != 1))        {            return $this->redirect('https://e-tibb.az');        }        return $this->renderPartial('/vue/doctor');    }    public function actionEnterprise()    {        $userID = Yii::$app->session->get('userID');        $userTYPE = Yii::$app->session->get('userType');        if(empty($userID) || ($userTYPE<=0 || $userTYPE != 2))        {            return $this->redirect('https://e-tibb.az');        }        return $this->renderPartial('/vue/enterprise');    }    /**     * Logout action.     * @return string     */    public function actionLogout()    {        Yii::$app->user->logout();        return $this->goHome();    }}