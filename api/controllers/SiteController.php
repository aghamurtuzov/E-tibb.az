<?phpnamespace api\controllers;use api\modules\general\models\AuthAssignment;use api\modules\general\models\AuthItem;use Yii;use yii\web\Controller;use yii\filters\VerbFilter;use yii\filters\AccessControl;use api\models\LoginForm;use api\controllers\ApiController;use yii\web\Response;use api\components\Functions;use api\models\AdminUsers;use api\models\SiteUsers;/** * Site controller */class SiteController extends ApiController{    public $modelClass = '';    public $serializer = [        'class' => 'yii\rest\Serializer',        'collectionEnvelope' => 'items',    ];    public function behaviors()    {        $behaviors = parent::behaviors();        $behaviors['contentNegotiator'] = [            'class' => 'yii\filters\ContentNegotiator',            'formats' => [                'application/json' => Response::FORMAT_JSON,            ],        ];        return $behaviors;    }    public function actions(){}    /**     * Displays homepage.     *     * @return string     */    public function actionNotlogin()    {        return $this->response(301,"Zəhmət olmasa hesabınıza daxil olun");    }    public function actionUser()    {        $session = Yii::$app->session;        $key = $session->get('gakey');        if(!empty($key))        {            $user = AdminUsers::find()->select(['id','name'])->where(new \yii\db\Expression('FIND_IN_SET(:key, login_key)'))->addParams([':key' => $key])->asArray()->one();            if(!empty($user))            {                $session->set('userId',$user["id"]);                $user["role"] = AuthAssignment::getPermission($user["id"]);                return $this->response(200,"Məlumat mövcuddur",$user);            }        }else{            if(!Yii::$app->user->isGuest)            {                $id = Yii::$app->user->identity->id;                return SiteUsers::find()->select(['id','name'])->where(['id'=>$id])->asArray()->one();            }        }    }    /**     * Logout action.     * @return string     */    public function actionLogout()    {        if(Yii::$app->user->isGuest)        {            $session = Yii::$app->session;            $key = $session->get('gakey');            if(!empty($key))            {                $user = AdminUsers::find()->where(new \yii\db\Expression('FIND_IN_SET(:key, login_key)'))->addParams([':key' => $key])->one();                if(!empty($user))                {                    if(!empty($user->login_key) && strpos($user->login_key,','))                    {                        $exp  = explode(',',$user->login_key);                        foreach($exp as $k => $v)                        {                            if($v == $key)                            {                                unset($exp[$k]);                            }                        }                        $exp = implode(',',$exp);                        $user->login_key = $exp;                    }else{                        $user->login_key = '';                    }                    $user->save(false);                    $session->remove('gakey');                    $session->remove('userID');                    $session->remove('userType');                    if(isset($_SERVER['HTTP_COOKIE']))                    {                        $cookies = explode(';', $_SERVER['HTTP_COOKIE']);                        foreach($cookies as $cookie) {                            $parts = explode('=', $cookie);                            $name = trim($parts[0]);                            setcookie($name, '', time()-1000);                            setcookie($name, '', time()-1000, '/');                        }                    }                }            }        }else{            Yii::$app->user->logout();        }        return $this->redirect("/");    }    /**     * {@inheritdoc}     *///    public function behaviors()//    {//        return [//            'access' => [//                'class' => AccessControl::className(),//                'rules' => [//                    [//                        'actions' => ['login','index'],//                        'allow' => true,//                    ],//                    [//                        'actions' => ['logout','error'],//                        'allow' => true,//                        'roles' => ['@'],//                    ],//                ],//            ],//            'verbs' => [//                'class' => VerbFilter::className(),//                'actions' => [//                    'logout' => ['post'],//                ],//            ],//        ];////    }    /**     * {@inheritdoc}     *///    public function actions()//    {//        return [//            'error' => [//                'class' => 'yii\web\ErrorAction',//            ],//        ];//    }    /**     * Displays homepage.     *     * @return string     *///    public function actionCpp()//    {//        return $this->renderPartial('/vue/index');//    }////    public function actionDoctor()//    {//        return $this->renderPartial('/vue/doctor');//    }    /**     * Login action.     * @return string     *///    public function actionLogin2()//    {////        /*//        $login = Yii::$app->params['firstLogin'];//        $pass  = Yii::$app->params['firstPass'];////        if ((md5(strrev(md5(@$_SERVER['PHP_AUTH_PW']))) != $pass || @$_SERVER['PHP_AUTH_USER'] != $login) || !@$_SERVER['PHP_AUTH_USER']) {//            header('WWW-Authenticate: Basic realm="Access denied"');//            header('HTTP/1.0 401 Unauthorized');//            echo 'Auth failed';//            exit;//        }//        */////        if (!Yii::$app->user->isGuest)//        {//            return $this->goHome();//        }////        $model = new LoginForm();////        if ($model->load(Yii::$app->request->post()) && $model->login()) {//            echo 'Ok';//            //return $this->goBack();//            //return $this->redirect(['doctors/index']);//        } else {//            $model->password = '';//            return $this->renderPartial('login', [//                'model' => $model,//            ]);//        }////    }}